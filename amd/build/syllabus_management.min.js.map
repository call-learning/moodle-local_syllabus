{"version":3,"file":"syllabus_management.min.js","sources":["../src/syllabus_management.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A javascript module to retrieve a course list from the server.\n *\n * @copyright  2020 CALL Learning 2020 - Laurent David laurent@call-learning.fr\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/str', 'core/notification', 'core/sortable_list'],\n    function($,\n              Ajax,\n              Str,\n              Notification,\n              SortableList\n              ) {\n        return {\n            init: function() {\n                // Sort fields who already have a location.\n                var sortwloc = new SortableList(\n                    $('#syllabus-management .location-list tbody'),\n                    {moveHandlerSelector: '.movefield [data-drag-type=move]'}\n                );\n                var locationName = function(element) {\n                    return element\n                        .closest('[data-location-id]')\n                        .attr('data-label');\n                };\n                var displayNoElementIfNeeded = function(evt) {\n                    evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                    // Refreshing fields tables.\n                    Str.get_string('therearenofields', 'core_customfield').then(function(s) {\n                        $('#syllabus-management .location-list').children().each(function() {\n                            var fields = $(this).find($('.field')),\n                                nofields = $(this).find($('.nofields'));\n                            if (!fields.length && !nofields.length) {\n                                $(this).find('tbody').append(\n                                    '<tr class=\"nofields\"><td colspan=\"5\">' + s + '</td></tr>'\n                                );\n                            }\n                            if (fields.length && nofields.length) {\n                                nofields.remove();\n                            }\n                        });\n                        return null;\n                    }).fail(Notification.exception);\n                };\n\n                var dropIntoList = function(evt, info) {\n                    evt.stopPropagation(); // Important for nested lists to prevent multiple targets.\n                    if (info.positionChanged) {\n                        const fieldid = info.element.data('field-id');\n                        const location = info.targetList.closest('[data-location-id]').attr('data-location-id');\n                        var beforeid = info.targetNextElement.data('field-id');\n                        var promises = Ajax.call([\n                            {\n                                methodname: 'local_syllabus_move_field_to_location',\n                                args: {\n                                    fieldid: fieldid,\n                                    location: location,\n                                    beforeid: beforeid\n                                },\n                            },\n                        ]);\n                        promises[0].fail(Notification.exception);\n                    }\n                };\n\n                sortwloc.getDestinationName = function(parentElement, afterElement) {\n                    if (!afterElement.length) {\n                        return Str.get_string('totopoflocation', 'local_syllabus', locationName(parentElement));\n                    } else if (afterElement.attr('data-field-name')) {\n                        return Str.get_string('afterfield', 'local_syllabus', afterElement.attr('data-field-name'));\n                    } else {\n                        return $.Deferred().resolve('');\n                    }\n                };\n\n                $('[data-field-name]').on('sortablelist-drop', function(evt, info) {\n                    dropIntoList(evt, info);\n                }).on('sortablelist-drag', function(evt) {\n                    displayNoElementIfNeeded(evt);\n                });\n\n                $('[data-field-name]').on('sortablelist-dragstart',\n                    function(evt, info) {\n                        setTimeout(function() {\n                            $('.sortable-list-is-dragged').width(info.element.width());\n                        }, 501);\n                    }\n                );\n                $(\"[data-role=removefield]\").on('click', function(e) {\n                    const fieldid = $(this).attr('data-id');\n                    Ajax.call([\n                        {\n                            methodname: 'local_syllabus_move_field_to_location',\n                            args: {\n                                fieldid: fieldid,\n                                location: 'none',\n                                beforeid: 0\n                            },\n                        }\n                    ])[0].then(function() {\n                        window.location.reload();\n                        return '';\n                    }).fail(Notification.exception);\n                    e.preventDefault();\n                });\n            },\n        };\n    });\n"],"names":["define","$","Ajax","Str","Notification","SortableList","init","sortwloc","moveHandlerSelector","getDestinationName","parentElement","afterElement","length","attr","get_string","Deferred","resolve","closest","on","evt","info","stopPropagation","positionChanged","fieldid","element","data","location","targetList","beforeid","targetNextElement","call","methodname","args","fail","exception","dropIntoList","then","s","children","each","fields","this","find","nofields","append","remove","displayNoElementIfNeeded","setTimeout","width","e","window","reload","preventDefault"],"mappings":";;;;;;AAqBAA,4CAAO,CAAC,SAAU,YAAa,WAAY,oBAAqB,uBAC5D,SAASC,EACCC,KACAC,IACAC,aACAC,oBAEC,CACHC,KAAM,eAEEC,SAAW,IAAIF,aACfJ,EAAE,6CACF,CAACO,oBAAqB,qCA+C1BD,SAASE,mBAAqB,SAASC,cAAeC,qBAC7CA,aAAaC,OAEPD,aAAaE,KAAK,mBAClBV,IAAIW,WAAW,aAAc,iBAAkBH,aAAaE,KAAK,oBAEjEZ,EAAEc,WAAWC,QAAQ,IAJrBb,IAAIW,WAAW,kBAAmB,iBAA+BJ,cA7CvEO,QAAQ,sBACRJ,KAAK,gBAoDdZ,EAAE,qBAAqBiB,GAAG,qBAAqB,SAASC,IAAKC,OA9B1C,SAASD,IAAKC,SAC7BD,IAAIE,kBACAD,KAAKE,gBAAiB,OAChBC,QAAUH,KAAKI,QAAQC,KAAK,YAC5BC,SAAWN,KAAKO,WAAWV,QAAQ,sBAAsBJ,KAAK,wBAChEe,SAAWR,KAAKS,kBAAkBJ,KAAK,YAC5BvB,KAAK4B,KAAK,CACrB,CACIC,WAAY,wCACZC,KAAM,CACFT,QAASA,QACTG,SAAUA,SACVE,SAAUA,aAIb,GAAGK,KAAK7B,aAAa8B,YAelCC,CAAahB,IAAKC,SACnBF,GAAG,qBAAqB,SAASC,MApDL,SAASA,KACpCA,IAAIE,kBAEJlB,IAAIW,WAAW,mBAAoB,oBAAoBsB,MAAK,SAASC,UACjEpC,EAAE,uCAAuCqC,WAAWC,MAAK,eACjDC,OAASvC,EAAEwC,MAAMC,KAAKzC,EAAE,WACxB0C,SAAW1C,EAAEwC,MAAMC,KAAKzC,EAAE,cACzBuC,OAAO5B,QAAW+B,SAAS/B,QAC5BX,EAAEwC,MAAMC,KAAK,SAASE,OAClB,wCAA0CP,EAAI,cAGlDG,OAAO5B,QAAU+B,SAAS/B,QAC1B+B,SAASE,YAGV,QACRZ,KAAK7B,aAAa8B,WAoCrBY,CAAyB3B,QAG7BlB,EAAE,qBAAqBiB,GAAG,0BACtB,SAASC,IAAKC,MACV2B,YAAW,WACP9C,EAAE,6BAA6B+C,MAAM5B,KAAKI,QAAQwB,WACnD,QAGX/C,EAAE,2BAA2BiB,GAAG,SAAS,SAAS+B,SACxC1B,QAAUtB,EAAEwC,MAAM5B,KAAK,WAC7BX,KAAK4B,KAAK,CACN,CACIC,WAAY,wCACZC,KAAM,CACFT,QAASA,QACTG,SAAU,OACVE,SAAU,MAGnB,GAAGQ,MAAK,kBACPc,OAAOxB,SAASyB,SACT,MACRlB,KAAK7B,aAAa8B,WACrBe,EAAEG"}